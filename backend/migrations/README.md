# Database Migrations

Alembic-based schema versioning and migration management for PostgreSQL.

## Structure

```
migrations/
├── alembic.ini              # Alembic configuration
├── env.py                   # Async SQLAlchemy environment setup
├── script.py.mako           # Migration template
├── versions/
│   └── 001_initial_schema.py  # Initial database schema
└── README.md                # This file
```

## Running Migrations

### View current revision

```bash
alembic current
```

### Apply all pending migrations

```bash
alembic upgrade head
```

### Apply specific migration

```bash
alembic upgrade <revision>
```

### Rollback to previous migration

```bash
alembic downgrade -1
```

### Rollback all migrations

```bash
alembic downgrade base
```

## Creating New Migrations

### Automatic (recommended)

After modifying models in `src/db/models.py`:

```bash
alembic revision --autogenerate -m "description of changes"
```

Then review the generated file in `versions/`.

### Manual

For complex changes:

```bash
alembic revision -m "description"
```

Edit the generated file in `versions/` with raw SQL or SQLAlchemy constructs.

## Migration File Format

Each migration file should include:

```python
"""Descriptive message

Revision ID: 002_add_something
Revises: 001_initial_schema
Create Date: 2025-12-10 00:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

revision = '002_add_something'
down_revision = '001_initial_schema'
branch_labels = None
depends_on = None

def upgrade() -> None:
    # Apply changes
    pass

def downgrade() -> None:
    # Revert changes
    pass
```

## Best Practices

1. **One change per migration** - Each migration should address one schema change
2. **Descriptive messages** - Use clear descriptions for each migration
3. **Test downgrades** - Always test that `downgrade()` works
4. **Review changes** - Review autogenerated migrations before committing
5. **Backwards compatibility** - Design migrations to support zero-downtime deployments

## Current Schema

### Version: 001_initial_schema

Creates 9 core tables:

- `users` - User accounts with authentication
- `user_profiles` - Extended profile information
- `modules` - Course modules
- `chapters` - Lessons within modules
- `embeddings` - Vector embeddings for search
- `chapter_progress` - Student progress tracking
- `chat_messages` - Conversation history
- `translations` - Multi-language support
- `capstone_submissions` - Student projects

All tables include:
- UUID primary keys
- `created_at` / `updated_at` timestamps
- Proper indexes for common queries
- Cascade delete for foreign keys

## Troubleshooting

### "Cannot import module src"

Ensure you're running Alembic from the `backend/` directory.

### Migration conflicts

If multiple developers create migrations simultaneously, they may conflict. In this case:

1. Rename one revision
2. Update `down_revision` to point to the previous one
3. Test both migrations

### Database locked

PostgreSQL may lock during long migrations. Use:

```sql
SELECT * FROM pg_stat_activity WHERE state != 'idle';
```

To see active connections, then terminate if needed.

## See Also

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy ORM](https://docs.sqlalchemy.org/20/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
